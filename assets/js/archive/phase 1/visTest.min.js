class CreateMap{constructor(){this.data={},this.itineraries={},this.trajectories={},this.intersections={},this.places={},this.authors={},this.author_names={},this.continents={},this.width=window.innerWidth,this.height=window.innerHeight,this.loading=[],this.range=[new Date(1890,1,1),new Date(2010,1,1)],this.date_start=this.range[0],this.date_end=this.range[1],this.mode=d3.select("#_01").classed("selected")?1:2,this.ttime=45}loading_manager(t){this.loading=this.loading.filter(function(e){return e!==t}),0===this.loading.length&&(this.process_data(),this.setup(),this.generate())}get_data(){var t=this,e=["author_ids","intersections","itineraries","places","continents"];e.forEach(function(e){t.loading.push(e)}),e.forEach(function(e){var a="data/three_"+e+".json";d3.json(a,function(a,n){a||(t.data[e]=n,t.loading_manager(e))})})}process_data(){var t=this;t.continents=t.data.continents,d3.keys(t.data.places).forEach(function(e){var a=e.split(",");a[0]=a[0].trim().split(" ").join("-"),a[1]=a[1].trim().split(" ").join("-"),a=a.join("_").toLowerCase(),t.places[a]=t.data.places[e],t.places[a].PlaceName=e}),d3.keys(t.data.author_ids).forEach(function(e){t.authors[t.data.author_ids[e]]=e,t.author_names[e]=t.data.author_ids[e]}),t.intersections=t.data.intersections,t.trajectories={},t.itineraries={},d3.keys(t.authors).forEach(function(e){t.itineraries[e]||(t.itineraries[e]=[])}),d3.keys(t.data.itineraries).forEach(function(e){t.data.itineraries[e].forEach(function(e){t.itineraries[e.AuthorID].push(e)})})}setup(){var t=this,e=d3.selectAll(".tab");this.svg=d3.select("#container").append("svg").attr("width",this.width),d3.select("#left_itinerary").append("select").attr("id","left_select").on("change",function(){t.route_change("left")}).selectAll("option").data(d3.keys(t.author_names)).enter().append("option").text(function(t){return t}),d3.select("#right_itinerary").append("select").attr("id","right_select").on("change",function(){t.route_change("right")}).selectAll("option").data(d3.keys(t.author_names)).enter().append("option").text(function(t){return t}),this.left_svg=d3.select("#left_itinerary").append("svg").attr("id","left_route"),this.right_svg=d3.select("#right_itinerary").append("svg").attr("id","right_route"),t.route_change("left"),t.route_change("right"),e.on("click",function(a){var n=d3.select(this),r=+n.attr("id").split("_")[1];t.switch_mode(r),e.classed("selected",!1),n.classed("selected",!0)})}generate(){this.tear_down(),1===this.mode?this.generate_map():this.generate_routes()}generate_map(){var t=this,e=!1,a=d3.selectAll(".sidebar_tab"),n=1;this.svg.attr("height",this.height),t.svg.on("click",function(t){d3.event.stopPropagation(),j(),P()}),a.on("click",function(t){var e=d3.select(this);a.classed("selected",!1),e.classed("selected",!0),n=+e.attr("id").split("_")[1],P()});var r=d3.time.scale().domain(this.range),i=d3.svg.axis().orient("right").ticks(20).tickSize(30).tickPadding(12),s=d3.slider().scale(r).axis(i).value([l(this.range[1]),l(this.range[0])]).orientation("vertical").margin(0).animate(!1).on("slide",function(e,a){var n=a[1]instanceof Date?a[1]:new Date(a[1]),r=a[0]instanceof Date?a[0]:new Date(a[0]);t.date_start=l(n),t.date_end=l(r),L(),S()}).on("slideend",function(t,e){S()});function l(e){var a=d3.time.scale().domain(r.domain()).range([0,t.height]).nice(d3.time.month);return a.invert(t.height-a(e))}d3.select("#slider .slider_body").call(s);d3.selectAll("#slider .slider_body .tick").last().style("display","none"),L();var c,o,d,u,h,_,p,f,g,v,m,D,y,k,E=d3.geo.mercator().scale(200).translate([.5*t.width,.65*t.height]),w=d3.geo.path().projection(E),x=topojson.feature(t.continents,t.continents.objects.continents);function A(){c={},o={},d={},u={};var e=d3.entries(t.intersections).filter(function(e){var a=new Date(e.key);return a>=t.date_start&&a<=t.date_end});e.forEach(function(t){d3.keys(t.value).length>0&&d3.keys(t.value).forEach(function(e){c[e]||(c[e]={},c[e].figures={}),t.value[e].forEach(function(t){(!c[e].figures[t.AuthorID]||c[e].figures[t.AuthorID]>t.Likelihood)&&(c[e].figures[t.AuthorID]=t.Likelihood)})})}),d3.keys(c).forEach(function(t){c[t].lists={},c[t].lists._01=d3.values(c[t].figures).filter(function(t){return 1===t}),c[t].lists._02=d3.values(c[t].figures).filter(function(t){return 2===t}),c[t].lists._03=d3.values(c[t].figures).filter(function(t){return 3===t})}),e.forEach(function(t){d3.keys(t.value).forEach(function(e){o[e]||(o[e]=[]),t.value[e].forEach(function(t){0===o[e].filter(function(e){return e.AuthorID===t.AuthorID&&e.EndDate===t.EndDate}).length&&o[e].push(t)})})}),e.forEach(function(t){d3.keys(t.value).forEach(function(e){t.value[e].forEach(function(t){d[t.AuthorID]||(d[t.AuthorID]=[]),0===d[t.AuthorID].filter(function(e){return e.PlaceID===t.PlaceID&&e.EndDate===t.EndDate}).length&&d[t.AuthorID].push(t)})})});for(var a=0,n=0;n<d3.keys(d).length;n++)for(var r=0;r<d[d3.keys(d)[n]].length-1;r++)d[d3.keys(d)[n]][r].PlaceID_End=d[d3.keys(d)[n]][r+1].PlaceID,d[d3.keys(d)[n]][r].Likelihood_End=d[d3.keys(d)[n]][r+1].Likelihood,d[d3.keys(d)[n]][r].tier=a,a=r%2*10;d3.keys(c).forEach(function(t){u[t]||(u[t]=[])}),d3.values(d).forEach(function(t){t.forEach(function(t){u[t.PlaceID]||(u[t.PlaceID]=[]),u[t.PlaceID_End]||(u[t.PlaceID_End]=[]),u[t.PlaceID].push(t),t.PlaceID_End&&u[t.PlaceID_End].push(t)})})}function I(){(m=t.svg.selectAll("g.lines_target").data([t])).enter().append("g").classed("lines_target",!0),m.exit().remove(),(D=m.selectAll("g.lines_g").data(d3.entries(d))).enter().append("g").classed("lines_g",!0),D.attr("class",function(e){return"lines_g id_"+d3.keys(t.authors).indexOf(e.key)}),D.exit().remove(),(y=D.selectAll("path.line").data(function(t){return t.value.filter(function(t){return t.PlaceID_End})})).enter().append("path").classed("line",!0),y.attr("d",function(e){var a,n,r=e.PlaceID||e.PlaceID_End,i=e.PlaceID_End||e.PlaceID;a=E([t.places[r].Long,t.places[r].Lat]);var s=(n=E([t.places[i].Long,t.places[i].Lat]))[0]-a[0],l=n[1]-a[1],c=Math.sqrt((s+e.tier)*(s+e.tier)+(l+e.tier)*(l+e.tier));return"M"+a[0]+","+a[1]+"A"+c+","+c+" 0 0,1 "+n[0]+","+n[1]}),y.exit().remove()}function b(){var a=d3.scale.linear().domain([0,10]).range([0,36]);(h=t.svg.selectAll("g.points_target").data([t])).enter().append("g").classed("points_target",!0),h.exit().remove(),(_=t.svg.selectAll("g.points_g").data(d3.entries(c))).enter().append("g").classed("points_g",!0),_.attr("transform",function(e){var a=E([t.places[e.key].Long,t.places[e.key].Lat]);return"translate("+a[0]+","+a[1]+")"}),_.on("mousemove",function(e){d3.select(this).transition().duration(t.ttime).attr("transform",function(e){var a=E([t.places[e.key].Long,t.places[e.key].Lat]);return"translate("+a[0]+","+a[1]+")scale(1.5)"})}).on("mouseout",function(e){d3.select(this).transition().duration(t.ttime/2).attr("transform",function(e){var a=E([t.places[e.key].Long,t.places[e.key].Lat]);return"translate("+a[0]+","+a[1]+")scale(1)"})}).on("click",function(t){d3.event.stopPropagation(),j(),t.key!==e.key&&(e=t,d3.select(this).classed("focus_point",!0)),P()}),_.exit().remove(),(p=_.selectAll("circle.point_back").data(function(t){return[t.value.lists._01]})).enter().append("circle").classed("point_back",!0),p.attr("cx",0).attr("cy",0).attr("r",function(t){var e=t.length+this.parentNode.__data__.value.lists._02.length+this.parentNode.__data__.value.lists._03.length;return a(e)}),p.exit().remove(),(v=_.selectAll("circle.point_01").data(function(t){return[t.value.lists._01]})).enter().append("circle").classed("point_01",!0),v.classed("point",!0).attr("cx",0).attr("cy",0).attr("r",function(t){var e=t.length+this.parentNode.__data__.value.lists._02.length+this.parentNode.__data__.value.lists._03.length;return a(e)}),v.exit().remove(),(g=_.selectAll("circle.point_02").data(function(t){return[t.value.lists._02]})).enter().append("circle").classed("point_02",!0),g.classed("point",!0).attr("cx",0).attr("cy",0).attr("r",function(t){var e=t.length+this.parentNode.__data__.value.lists._03.length;return a(e)}),g.exit().remove(),(f=_.selectAll("circle.point_03").data(function(t){return[t.value.lists._03]})).enter().append("circle").classed("point_03",!0),f.classed("point",!0).attr("cx",0).attr("cy",0).attr("r",function(t){var e=t.length;return a(e)}),f.exit().remove()}function P(){var a=d3.scale.linear().domain([0,3]).range([.5,1]);if(e){d3.select("#sidebar_title").html("&#8618;&nbsp;"+t.places[e.key].PlaceName);var r,i,s=1===n?o[e.key]||[]:u[e.key];(r=d3.select("#sidebar_items").selectAll("li.item").data(s)).enter().append("li").classed("item",!0),r.attr("class",function(e){return"item id_"+d3.keys(t.authors).indexOf(e.AuthorID)}).style("opacity",function(t){return a(t.Likelihood)}).html(function(e){return t.authors[e.AuthorID]}),r.exit().remove(),(i=r.selectAll("div.item_date").data(function(t){return[t]})).enter().append("div").classed("item_date",!0),i.html(function(a){var r;if(1===n)r=a.StartDate&&a.EndDate?a.StartDate+"&nbsp;&ndash;&nbsp;"+a.EndDate:a.StartDate?a.StartDate+"&nbsp;&ndash;":a.EndDate?"&nbsp;&ndash;"+a.EndDate:"";else{var i=a.PlaceID===e.key?"accent":"",s=a.PlaceID_End&&a.PlaceID_End===e.key?"accent":"",l='<span class="_'+a.Likelihood+" "+i+'">'+t.places[a.PlaceID].PlaceName+"</span>",c='<span class="_'+a.Likelihood_End+" "+s+'">'+(a.PlaceID_End?t.places[a.PlaceID_End].PlaceName:"")+"</span>";r='<div class="b">'+(a.EndDate||"")+"</div><div>"+l+"&nbsp;&rarr;&nbsp;"+c+"</div>"}return r}),i.exit().remove()}else d3.select("#sidebar_title").html(""),d3.select("#sidebar_items").html("")}function L(){var e=d3.time.format("%b. %Y");d3.select("#date_start").html(e(t.date_start)),d3.select("#date_end").html(e(t.date_end))}function S(){A(),I(),b(),P()}function j(){e=!1,d3.selectAll(".focus_point").classed("focus_point",!1)}(k=t.svg.selectAll("path.map").data([x])).enter().append("path").classed("map",!0),k.attr("d",w),k.exit().remove(),A(),I(),b(),P()}route_change(t){var e,a=d3.select("#"+t+"_select").property("value"),n=this.author_names[a];e="left"==t?this.left_svg:this.right_svg;var r=this,i=6*this.height;e.attr("height",i);var s=[],l=[];d3.keys(r.itineraries).forEach(function(t){s.push(d3.min(r.itineraries[t],function(t){return new Date(t.StartDate)})),l.push(d3.max(r.itineraries[t],function(t){return new Date(t.EndDate)}))});var c=d3.min(s),o=d3.max(l),d=d3.time.scale().domain([c,o]).range([0,i-150-60]),u=e.selectAll("g.route_g").data(n);u.enter().append("g").classed("route_g",!0),u.attr("class","route_g author_"+t).attr("transform",function(t,e){return"translate("+e*(r.width/2)+",150)"}),u.exit().remove();var h=u.selectAll("line.route_line_background").data(r.itineraries[n]);h.enter().append("line").classed("route_line_background",!0),h.attr("x1",r.width/4).attr("y1",function(t,e){return d(d.domain()[0])}).attr("x2",r.width/4).attr("y2",function(t,e){return d(d.domain()[1])}),h.exit().remove();var _=u.selectAll("text.route_label").data(n);_.enter().append("text").classed("route_label",!0),_.attr("x",r.width/4).attr("y",-30).text(a),_.exit().remove();var p=u.selectAll("line.route_line").data(r.itineraries[n]);p.enter().append("line").classed("route_line",!0),p.attr("class","route_line author_"+t).attr("x1",r.width/4).attr("y1",function(t,e){return t.StartDate?d(new Date(t.StartDate)):d(new Date(t.EndDate))}).attr("x2",r.width/4).attr("y2",function(t,e){return t.EndDate?d(new Date(t.EndDate)):d(new Date(t.StartDate))}),p.exit().remove();var f=u.selectAll("line.route_points").data(r.itineraries[n]);f.enter().append("line").classed("route_points",!0),f.attr("x1",r.width/4-15).attr("y1",function(t,e){return t.StartDate?d(new Date(t.StartDate)):d(new Date(t.EndDate))}).attr("x2",r.width/4+45).attr("y2",function(t,e){return t.StartDate?d(new Date(t.StartDate)):d(new Date(t.EndDate))}),f.exit().remove();var g=u.selectAll("circle.route_stops").data(r.itineraries[n]);g.enter().append("circle").classed("route_stops",!0),g.attr("cx",r.width/4+45).attr("cy",function(t,e){return t.StartDate?d(new Date(t.StartDate)):d(new Date(t.EndDate))}).attr("r",3),g.exit().remove();var v=u.selectAll("text.route_point_labels").data(r.itineraries[n]);v.enter().append("text").classed("route_point_labels",!0),v.attr("x",r.width/4+60).attr("y",function(t,e){return(t.StartDate?d(new Date(t.StartDate)):d(new Date(t.EndDate)))+4}).text(function(t){var e=t.StartDate||"Unknown",a=t.EndDate||"Unknown";return r.places[t.PlaceID].PlaceName+" ("+e+" to "+a+")"}),v.exit().remove()}generate_routes(){var t=6*this.height;this.svg.attr("height",t)}switch_mode(t){this.mode=t,this.tear_down(),1===this.mode?this.generate_map():this.generate_routes()}tear_down(){var t=1===this.mode?2:1;this.svg.selectAll("*").remove(),d3.select("#slider .slider_body").selectAll("*").remove(),d3.selectAll(".sidebar_tab.selected").classed("selected",!1),d3.select(".sidebar_tab#sidebar_01").classed("selected",!0),d3.selectAll("._0"+t).style("display","none"),d3.selectAll("._0"+this.mode).style("display","block"),this.date_start=this.range[0],this.date_end=this.range[1]}}var vis=new CreateMap;vis.get_data(),d3.selection.prototype.first=function(){return d3.select(this[0][0])},d3.selection.prototype.last=function(){var t=this.size()-1;return d3.select(this[0][t])};
//# sourceMappingURL=../../maps/archive/phase 1/visTest.min.js.map
